<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="fproof" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <statements>
    <!-- 원재료 매입 등록 -->
    <!--<select id="SelectPurRegMstList" parameterClass="ModelsLibrary.Fproof.FproofVo" resultClass="ModelsLibrary.Fproof.FproofVo">
         SELECT T1.CHNL_CD
             , T1.MTRL_LOT_NO
             , T1.CO_LOT_NO
             , T1.ITM_CD     
             , T2.ITM_NM     
             , T2.CAR_ITM_NM 
             , T2.ITM_SZ_NM  
             , T2.UOM_CD 
             , dbo.CD_SYS_CLSS_FNC(T1.CHNL_CD, 'L-003', T2.UOM_CD) AS UOM_NM 
             , T1.ITM_QTY 
             , T1.CO_CD       
             , T1.CO_CD      AS CO_NO 
             , dbo.CD_COMPANY_NM_FNC(T1.CHNL_CD, T1.CO_CD)  AS CO_NM
             , CONVERT(VARCHAR, T1.ITM_IN_DT, 23) AS ITM_IN_DT
             , CONVERT(VARCHAR, T1.MTRL_MAKE_DT, 23) AS MTRL_MAKE_DT 
             , CONVERT(VARCHAR, T1.MTRL_MAKE_DT + T1.MTRL_EXP_DY, 23)  AS MTRL_EXP_DT 
             , ISNULL(T1.MTRL_EXP_DY, 0) AS MTRL_EXP_DY
             , (CASE WHEN DATEDIFF(DAY, GETDATE(), (T1.MTRL_MAKE_DT + T1.MTRL_EXP_DY)) > 0 THEN 'N' ELSE 'Y' END) AS GBN 
             , '입고' AS ROUT_NM
             , T1.PRNT_LOT_NO
             , dbo.PUR_N1ST_GRP_NM_FNC(T1.CHNL_CD, T2.ITM_GRP_CLSS_CD , T2.N1ST_ITM_GRP_CD) AS N1ST_ITM_GRP_NM 
             , ( CASE WHEN (SELECT COUNT(*) FROM TB_FPRF_MTRL_INSP  Z  WHERE Z.CHNL_CD = T1.CHNL_CD AND Z.MTRL_LOT_NO  = T1.MTRL_LOT_NO) <![CDATA[<=]]> 0 THEN 'N' ELSE 'Y' END )  AS FILE_FLG
             , ISNULL(dbo.FF_N1ST_RMN_QTY(T1.CHNL_CD, T1.MTRL_LOT_NO), 0) AS RMN_QTY
             , (CASE WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO) = 0 THEN 'NG' 
                   WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO AND X.CFM_FLG = 'N') = 0 THEN 'OK' 
                   ELSE  'NG' END) AS OK_FLG
             , (CASE WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO) = 0 THEN 0 
                    WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO AND X.CFM_FLG = 'N') = 0 THEN 1 
                   ELSE  0 END) AS isCheckd
             , (SELECT COUNT(*) AS  RN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO) AS RN
             , ISNULL(T2.SFSTK_QTY, 0) AS SFSTK_QTY
             , T1.CLZ_FLG
             , #CRE_USR_ID# AS CRE_USR_ID
             , #CRE_USR_ID# AS UPD_USR_ID
          FROM TB_FPRF_N1ST_STEP_ROUT T1
             , TB_CD_ITM T2 
         WHERE 1 = 1 
           AND T1.CHNL_CD = T2.CHNL_CD
           AND T1.ITM_CD  = T2.ITM_CD
           AND T1.CHNL_CD = #CHNL_CD#
          <isNotNull property="FM_DT">
            AND ITM_IN_DT >= CAST(CONVERT(VARCHAR, #FM_DT#, 120) + ' 00:00:00' AS DATETIME)
            AND ITM_IN_DT <![CDATA[ <= ]]> CAST(CONVERT(VARCHAR, #TO_DT#, 120) + ' 23:59:59' AS DATETIME)
          </isNotNull>
		   <isNotNull property="MTRL_LOT_NO">
			   AND T1.MTRL_LOT_NO = #MTRL_LOT_NO#
			</isNotNull>
          ORDER BY T1.MTRL_LOT_NO DESC
    </select>-->
    
     <!-- 11/19 원재료 매입 등록 - 로보콘 MES, 작성자 : 서동우 -->
     <select id="SelectPurRegMstList"  parameterClass="ModelsLibrary.Fproof.FproofVo" resultClass="ModelsLibrary.Fproof.FproofVo">
        SELECT    T1.CHNL_CD
                , T1.ITM_CD
                , T2.ITM_NM
                , T2.CAR_ITM_NM
                , T2.ITM_SZ_NM
                , T1.MTRL_LOT_NO
                , CONVERT(VARCHAR, T1.ITM_IN_DT, 23) AS ITM_IN_DT
                , T1.CO_CD
                , T3.CO_NM
                , CONVERT(FLOAT, T1.ITM_QTY) AS ITM_QTY
                , T2.UOM_CD
                <!--, dbo.CD_SYS_CLSS_FNC(T1.CHNL_CD, 'L-003', T2.UOM_CD) AS UOM_NM-->
                ,(
                  SELECT TOP 1 CLSS_DESC
                  FROM TB_SYS_CLSS_CD
                 WHERE USE_ST_DT <![CDATA[ <= ]]> GETDATE()
                   AND USE_END_DT <![CDATA[ >= ]]> GETDATE()
                    AND DELT_FLG = 'N'
                    AND CLSS_TP_CD = 'L-003'
                    AND CLSS_CD = T2.UOM_CD
                   AND CHNL_CD = T1.CHNL_CD   
                )  AS UOM_NM
                , T1.PRNT_LOT_NO
                , T1.CLZ_FLG
                , (CASE WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO) = 0 THEN 'NG'
                WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO AND X.CFM_FLG = 'N') = 0 THEN 'OK'
                ELSE  'NG' END) AS OK_FLG
                , (CASE WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO) = 0 THEN 0
                WHEN (SELECT COUNT(*) AS  GBN  FROM TB_FPRF_MTRL_INSP X WHERE 1=1 AND X.CHNL_CD = T1.CHNL_CD AND X.MTRL_LOT_NO = T1.MTRL_LOT_NO AND X.CFM_FLG = 'N') = 0 THEN 1
                ELSE  0 END) AS isCheckd
                , dbo.PUR_N1ST_GRP_NM_FNC(T1.CHNL_CD, T2.ITM_GRP_CLSS_CD, T2.N1ST_ITM_GRP_CD) AS N1ST_ITM_GRP_NM
              , T1.CRE_DT
              , T1.CRE_USR_ID
              , T1.UPD_DT
              , T1.UPD_USR_ID
          FROM TB_FPRF_N1ST_STEP_ROUT T1
             , TB_CD_ITM T2
             , TB_CD_CO T3
         WHERE 1 = 1
            AND T1.CHNL_CD   = T2.CHNL_CD
            AND T1.CHNL_CD   = T3.CHNL_CD
            AND T1.ITM_CD    = T2.ITM_CD
            AND T1.CO_CD     = T3.CO_NO
            AND T1.CHNL_CD   = #CHNL_CD#
           
           <isNotNull property="N1ST_ITM_GRP_NM">
            AND dbo.PUR_N1ST_GRP_NM_FNC(T1.CHNL_CD, T2.ITM_GRP_CLSS_CD, T2.N1ST_ITM_GRP_CD) = #N1ST_ITM_GRP_NM#
           </isNotNull>
        <isNotNull property="FM_DT">
           AND ITM_IN_DT >= CAST(CONVERT(VARCHAR, #FM_DT#, 120) + ' 00:00:00' AS DATETIME)
           AND ITM_IN_DT <![CDATA[ <= ]]> CAST(CONVERT(VARCHAR, #TO_DT#, 120) + ' 23:59:59' AS DATETIME)
        </isNotNull>
        ORDER BY T1.MTRL_LOT_NO
     </select>
    
    
    <!--<insert id="InsertPurRegMst" parameterClass="ModelsLibrary.Fproof.FproofVo">
       INSERT INTO TB_FPRF_N1ST_STEP_ROUT
       (
            CHNL_CD
          , MTRL_LOT_NO
          , ITM_CD
          , ITM_IN_DT
          , CO_CD
          , ITM_QTY
          , MTRL_MAKE_DT
          , MTRL_EXP_DY
          , CRE_USR_ID
          , CRE_DT
          , UPD_USR_ID
          , UPD_DT
          , PRNT_LOT_NO
          , CLZ_FLG
        )
        SELECT
            #CHNL_CD#
          , dbo.FF_FPRF_N1ST_STEP_LOTNO(#CHNL_CD#, #ITM_IN_DT#) 
          , #ITM_CD#
          , CONVERT(DATETIME, #ITM_IN_DT#)
          , #CO_NO#
          , #ITM_QTY#
          , CONVERT(DATETIME, #MTRL_MAKE_DT#) 
          , #MTRL_EXP_DY#
          , #CRE_USR_ID#
          , GETDATE()
          , #UPD_USR_ID#
          , GETDATE()
          , #PRNT_LOT_NO#
          , #CLZ_FLG#
    </insert>-->

    <!--매입등록 - 추가test 작성자 : 서동우-->
    <insert id="InsertPurRegMst" parameterClass="ModelsLibrary.Fproof.FproofVo">
      INSERT INTO TB_FPRF_N1ST_STEP_ROUT
      (
          CHNL_CD
        , MTRL_LOT_NO
        , ITM_CD
        , ITM_IN_DT
        , CO_CD
        , ITM_QTY
        , CRE_USR_ID
        , CRE_DT
        , UPD_USR_ID
        , UPD_DT
        , CLZ_FLG
        , LOC_CD
      )
      SELECT
          #CHNL_CD#
        , (SELECT dbo.FF_FPRF_N1ST_STEP_LOTNO(#CHNL_CD#, CONVERT(DATETIME, GETDATE())))
        , #ITM_CD#
        , CONVERT(DATETIME, #ITM_IN_DT#)
        , #CO_CD#
        , #ITM_QTY#
        , 'MES'
        , GETDATE()
        , 'MES'
        , GETDATE()
        , #CLZ_FLG#
        , '100'
    </insert>



    <update id="UpdatePurRegMst" parameterClass="ModelsLibrary.Fproof.FproofVo">
      UPDATE TB_FPRF_N1ST_STEP_ROUT
         SET UPD_DT          = GETDATE()
      <isNotNull property="UPD_USR_ID">
          , UPD_USR_ID      = #UPD_USR_ID#
      </isNotNull>
      <isNotNull property="ITM_CD">
           , ITM_CD					= #ITM_CD#
      </isNotNull>
      <isNotNull property="ITM_IN_DT">
          , ITM_IN_DT       = CONVERT(DATETIME, #ITM_IN_DT#)
      </isNotNull>
      <isNotNull property="CO_NO">
          , CO_CD           = #CO_NO#
      </isNotNull>
      <isNotNull property="ITM_QTY">
          , ITM_QTY         = #ITM_QTY#
      </isNotNull>
      <isNotNull property="MTRL_MAKE_DT">
          , MTRL_MAKE_DT    = CONVERT(DATETIME, #MTRL_MAKE_DT#)
      </isNotNull>
      <isNotNull property="MTRL_EXP_DY">
          , MTRL_EXP_DY     = #MTRL_EXP_DY#
      </isNotNull>
      <isNotNull property="PRNT_LOT_NO">
          , PRNT_LOT_NO     = #PRNT_LOT_NO#
      </isNotNull>
      <isNotNull property="CLZ_FLG">
          , CLZ_FLG         = #CLZ_FLG#
      </isNotNull>
       WHERE 1=1 
      <isNotNull property="CHNL_CD">
         AND CHNL_CD          = #CHNL_CD#
      </isNotNull>
         AND MTRL_LOT_NO      = #MTRL_LOT_NO#
    </update>

    
    <!--
    <select id="SelectIsDeletePurRegMst" parameterClass="ModelsLibrary.Fproof.FproofVo" resultClass="ModelsLibrary.Fproof.FproofVo">
     SELECT (CASE WHEN COUNT(*) > 0 THEN 'N' ELSE 'Y' END) AS GBN
        FROM TB_FPRF_N2ND_JOIN_ROUT
       WHERE 1 = 1
         AND CHNL_CD     = #CHNL_CD#
         AND PRNT_LOT_NO = #MTRL_LOT_NO#
    </select>
      
    <delete id="DeletePurRegMst" parameterClass="ModelsLibrary.Fproof.FproofVo">
      DELETE FROM TB_FPRF_N1ST_STEP_ROUT
       WHERE CHNL_CD     = #CHNL_CD#
        AND MTRL_LOT_NO = #MTRL_LOT_NO#
    </delete>
    -->
    
  
  <!-- 설비 통합 모니터링 -->
  <select id="SelectEqMstList" parameterClass="ModelsLibrary.Fproof.FproofVo" resultClass="ModelsLibrary.Fproof.FproofVo">
    <!--
      SELECT #CHNL_CD#            AS CHNL_CD
           , T1.EQ_NO 
           , dbo.FF_EQ_NM_FNC(#CHNL_CD#, T1.EQ_NO)  AS EQ_NM
           , T1.SENSOR_NO         
           , T1.SENSOR_NM         
           , T2.SENSOR_SUM_VAL    AS SENSOR_VAL
        FROM TB_EQ_SENSOR_MAPG T1
           , (
              SELECT SENSOR_NO
                  ,  SUM(SENSOR_VAL) AS SENSOR_SUM_VAL 
                FROM TB_SENSOR_IF
              GROUP  BY    SENSOR_NO
             ) T2
       WHERE 1 = 1
         AND T1.SENSOR_NO = T2.SENSOR_NO
         AND T1.CHNL_CD   = #CHNL_CD#
         -->
          SELECT ROUT_CD
             , IF_QTY     AS SENSOR_VAL
             , CHNL_CD
             , PROC_LOT_NO
          FROM TB_MES_MCHN_IF
        WHERE 1 = 1
          AND CHNL_CD       = #CHNL_CD# 
  </select>

  <select id="SelectEqMonitoringList" parameterClass="ModelsLibrary.Fproof.FproofVo" resultClass="ModelsLibrary.Fproof.FproofVo">
    SELECT  SENSOR_NO, SENSOR_SEQ, SENSOR_VAL  FROM TB_SENSOR_IF WHERE 1=1 
    <isNotNull property="SENSOR_NO">
      AND SENSOR_NO = #SENSOR_NO#
    </isNotNull>
  </select>
      
  <select id="SelectProcLotNoList" parameterClass="ModelsLibrary.Fproof.FproofVo" resultClass="ModelsLibrary.Fproof.FproofVo">
      SELECT T1.PROC_LOT_NO
        ,  T1.CHNL_CD
        ,  T1.ROUT_ITM_CD
        ,  T2.ITM_NM
      FROM TB_FPRF_N2ND_ROUT  T1
         , TB_CD_ITM          T2 
     WHERE 1 = 1
       AND T1.CHNL_CD           = #CHNL_CD#
       AND T1.CHNL_CD           = T2.CHNL_CD
       AND T1.ROUT_ITM_CD       = T2.ITM_CD
       AND T1.MAKE_DT           >= CAST(#FM_DT# + ' 00:00:00' AS DATETIME)
       AND T1.MAKE_DT <![CDATA[ <= ]]> CAST(#TO_DT# + ' 23:59:59' AS DATETIME)
  </select>
   
  

    <!-- 원료 투입 -->
 <select id="SelectMaterialInputMstList" parameterClass="ModelsLibrary.Fproof.FproofVo" resultClass="ModelsLibrary.Fproof.FproofVo">
        SELECT  T1.CHNL_CD
          , T1.PROC_LOT_NO
          , T1.PROC_LOT_SEQ
          , T1.PRNT_LOT_NO
          , T1.ROUT_ITM_CD
          , T3.ITM_NM
          , T1.ITM_USE_QTY
          , dbo.CD_SYS_CLSS_FNC(T1.CHNL_CD, 'L-003', T4.N1ST_UOM_CD)  AS N1ST_UOM_NM  
          , T2.CLZ_FLG
          , CASE WHEN T2.CLZ_FLG = 'N' THEN '../../Content/Images/check_box_T.png' ELSE '../../Content/Images/check_box_F.png' END AS A_FLG
          , (T1.CHNL_CD + '_' + T1.PROC_LOT_NO + '_' + CONVERT(VARCHAR, T1.PROC_LOT_SEQ) + '_' + T1.PRNT_LOT_NO)  AS GBN
      FROM TB_FPRF_N2ND_JOIN_ROUT  T1
         , TB_FPRF_N1ST_STEP_ROUT  T2
         , TB_CD_ITM               T3
           LEFT OUTER JOIN TB_CD_ITM_PCK T4  ON ( T3.ITM_CD  = T4.ITM_CD AND T3.CHNL_CD = T4.CHNL_CD )
       WHERE 1 = 1 
         AND T1.CHNL_CD      = #CHNL_CD#
         AND T1.PROC_LOT_NO  = #PROC_LOT_NO#
         AND T1.ROUT_ITM_CD  = T3.ITM_CD 
         AND T1.PRNT_LOT_NO  = T2.CO_LOT_NO   
    </select>

     <insert id="InsertMaterialInputMst" parameterClass="ModelsLibrary.Fproof.FproofVo">
       INSERT INTO TB_FPRF_N2ND_JOIN_ROUT
       (
         CHNL_CD
       , PROC_LOT_NO
       , PROC_LOT_SEQ
       , PRNT_LOT_NO
       , ROUT_ITM_CD
       , ITM_USE_QTY
       , CRE_USR_ID
       , CRE_DT
       , UPD_USR_ID
       , UPD_DT
       )
       SELECT
         #CHNL_CD#
       , #PROC_LOT_NO#
       , ISNULL((SELECT MAX(PROC_LOT_SEQ) + 1 FROM TB_FPRF_N2ND_JOIN_ROUT WHERE 1 = 1 AND CHNL_CD =  #CHNL_CD# AND PROC_LOT_NO = #PROC_LOT_NO#), 1)
       , #PRNT_LOT_NO#
       , ISNULL((SELECT MAX(ITM_CD)  FROM TB_FPRF_N1ST_STEP_ROUT T1 WHERE 1 = 1 AND T1.CHNL_CD = #CHNL_CD# AND T1.CO_LOT_NO = #PRNT_LOT_NO#), '')
       , #ITM_USE_QTY#
       , #CRE_USR_ID#
       , GETDATE()
       , #UPD_USR_ID#
       , GETDATE()
     </insert>
    
     <delete id="DeleteMaterialInputMst" parameterClass="ModelsLibrary.Fproof.FproofVo">
      DELETE FROM TB_FPRF_N2ND_JOIN_ROUT
        WHERE 1 = 1
          AND CHNL_CD       = #CHNL_CD#  
          AND PROC_LOT_NO   = #PROC_LOT_NO#
          AND PROC_LOT_SEQ  = #PROC_LOT_SEQ#
    </delete>


    <update id="UpdateMaterialInputMst" parameterClass="ModelsLibrary.Fproof.FproofVo">
      UPDATE TB_FPRF_N1ST_STEP_ROUT
         SET CLZ_FLG = #CLZ_FLG#
       WHERE 1 = 1
         AND CHNL_CD        = #CHNL_CD# 
         AND CO_LOT_NO      = #PRNT_LOT_NO#
    </update>

  </statements>
</sqlMap>