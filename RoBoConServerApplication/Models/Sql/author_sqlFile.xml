<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="author" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <statements>
    <!-- 그룹(조직) 조회 컬럼설명 : GRP_TP_CD = G(그룹), R(ROLL) -->
    <select id="S136SelectGroupList" resultClass="ModelsLibrary.Auth.GroupUserVo" parameterClass="ModelsLibrary.Auth.GroupUserVo">
      SELECT CAST(GRP_ID  AS VARCHAR) AS GRP_ID
      , CAST(PRNT_GRP_ID  AS VARCHAR) AS PRNT_GRP_ID
      , GRP_NM
      , GRP_DESC
      , GRP_TP_CD
      , CAST(GRP_ROLL_ID  AS VARCHAR) AS GRP_ROLL_ID
      , CHNL_CD 
	  , OSTR_FLG
      FROM TB_SYS_GRP
      WHERE 1 = 1
        AND CHNL_CD = #CHNL_CD#
      <isNotNull property="GRP_ID" >
        AND GRP_ID = #GRP_ID#
      </isNotNull>
      <isNotNull property="PRNT_GRP_ID" >
        AND PRNT_GRP_ID =  #PRNT_GRP_ID#
      </isNotNull>
      <isNotNull property="GRP_NM" >
        AND GRP_NM LIKE #GRP_NM# + '%'
      </isNotNull>
      <isNotNull property="GRP_TP_CD" >
        AND GRP_TP_CD = #GRP_TP_CD#
      </isNotNull>
  </select>
    
    <!-- 그룹추가 -->
    <insert id="S136InsertGroupCode" parameterClass="ModelsLibrary.Auth.GroupUserVo">
      INSERT INTO TB_SYS_GRP (
          PRNT_GRP_ID
        , GRP_NM
        , GRP_DESC
        , GRP_TP_CD
        , GRP_ROLL_ID
        , CRE_USR_ID
        , CRE_DT
        , UPD_USR_ID
        , UPD_DT
        , CHNL_CD
		, OSTR_FLG
      ) VALUES (
          #PRNT_GRP_ID#
        , #GRP_NM#
        , #GRP_DESC#
        , #GRP_TP_CD#
        , #GRP_ROLL_ID#
        , #CRE_USR_ID#
        , GETDATE()
        , #UPD_USR_ID#
        , GETDATE()
        , #CHNL_CD#
		, #OSTR_FLG#
      )      
    </insert>
    <!-- 그룹수정 -->
    <update id="S136UpdateGroupCode" parameterClass="ModelsLibrary.Auth.GroupUserVo">
      UPDATE TB_SYS_GRP
      SET  PRNT_GRP_ID    = #PRNT_GRP_ID#
        , GRP_NM          = #GRP_NM#
        , GRP_DESC        = #GRP_DESC#
        , GRP_TP_CD       = #GRP_TP_CD#
        , GRP_ROLL_ID     = #GRP_ROLL_ID#
        , UPD_USR_ID      = #UPD_USR_ID#
        , UPD_DT          = GETDATE()
		, OSTR_FLG        = #OSTR_FLG#
      WHERE 1 = 1
        AND GRP_ID = #GRP_ID#
        AND CHNL_CD = #CHNL_CD#
    </update>
    
    <!-- 그룹삭제 -->
    <!-- 해당 그룹안에 사용자가 없으면 삭제처리 되게끔 제약 조건 정의 하였음. -->
    <delete id="S136DeleteGroupCode" parameterClass="ModelsLibrary.Auth.GroupUserVo">
      DELETE FROM TB_SYS_GRP
      WHERE 1 = 1
        AND GRP_ID = #GRP_ID#
        AND CHNL_CD = #CHNL_CD#
        AND 0 = (SELECT COUNT(*)
                    FROM TB_SYS_USR
                    WHERE GRP_ID = #GRP_ID# AND CHNL_CD = #CHNL_CD#)
    </delete>
    
    <!-- 사용자 조회-->
    <!-- 해당 그룹안에 사용자가 없으면 삭제처리 되게끔 제약 조건 정의 하였음. -->
    <select id="S136SelectUserList" resultClass="ModelsLibrary.Auth.GroupUserVo" parameterClass="ModelsLibrary.Auth.GroupUserVo">
		SELECT  USR_ID
		, USR_PWD
		, USR_N1ST_NM
		, USR_LST_NM
		, GRP_ID
		, ISNULL((SELECT GRP_NM FROM TB_SYS_GRP AS A WHERE 1=1 AND A.CHNL_CD = #CHNL_CD# AND  A.GRP_ID = B.GRP_ID), '')  AS GRP_NM
		, PHN_NO
		, CELL_PHN_NO
		, EML_ID
		, ADDR
		, DTL_ADDR
		, LST_LGN_IP
		, LST_LGN_DT
		, DELT_FLG
		, CRE_USR_ID
		, CRE_DT
		, UPD_USR_ID
		, UPD_DT
		, EMPE_NO
		, RESDNT_RGST_NO
		, OFC_PSN_CD
		, dbo.CD_SYS_CLSS_FNC(#CHNL_CD#, 'G-001', OFC_PSN_CD) AS OFC_PSN_NM
		, CONVERT(VARCHAR, JOIN_CO_DT, 23) AS JOIN_CO_DT
		, CONVERT(VARCHAR, RESGN_CO_DT, 23) AS RESGN_CO_DT
		, dbo.CD_SYS_CLSS_FNC(#CHNL_CD#, 'L-002', EMPE_PLC_NM) AS EMPE_PLC_CD
		, EMPE_PLC_NM
		, LAST_ORD_NO
		, USR_IMG
		, SGN_NM
		, CHNL_CD
		, (SELECT x.CHNL_NM FROM TB_CHNL_CD AS x WHERE DELT_FLG  = 'N' AND CHNL_CD   = #CHNL_CD#) AS CHNL_NM
		, CASE WHEN ISNULL(TM_PAY_FLG, 'N') = 'Y' THEN 1 ELSE 0 END AS TM_PAY_FLG
		, TM_PAY_AMT
		, EMP_LOC_CD
		, dbo.CD_SYS_CLSS_FNC(#CHNL_CD#, 'S-051', EMP_LOC_CD) AS EMP_LOC_NM
		, A.OSTR_FLG
		, A.PRNT_GRP_ID
		, (SELECT SUBSTRING(REPLACE(ITEMVALUE, '.', '') + '0000', 0, 8) FROM CT_USERDEF
		WHERE ITEM = 'CLIENT_VER') CLIENT_VER
		, (SELECT DB_NAME()) DBNAME
		FROM TB_SYS_USR AS B
		OUTER APPLY (
		SELECT PRNT_GRP_ID
		, CASE WHEN X.OSTR_FLG = 'Y' THEN 'Y'
		WHEN X.PRNT_GRP_ID IS NOT NULL THEN 'N'
		ELSE 'R' END AS OSTR_FLG
		FROM TB_SYS_GRP X
		WHERE 1 = 1
		AND B.CHNL_CD = X.CHNL_CD
		AND B.GRP_ID  = X.GRP_ID
		) A
		WHERE 1=1
		<isNotNull property="USR_ID" >
        AND USR_ID = #USR_ID#
      </isNotNull>
      <isNotNull property="DELT_FLG" >
        AND DELT_FLG = #DELT_FLG#
      </isNotNull>
        AND CHNL_CD = #CHNL_CD#
      <isNotNull property="GRP_ID" >
        AND GRP_ID = #GRP_ID#
      </isNotNull>
    </select>
    
    <!-- 사용자 정보 추가 -->    
    <insert id ="S136InsertUserInfo" parameterClass="ModelsLibrary.Auth.GroupUserVo">
      INSERT INTO TB_SYS_USR
      (
          USR_ID
        , USR_PWD
        , USR_N1ST_NM
        , USR_LST_NM
        , GRP_ID
        , PHN_NO
        , CELL_PHN_NO
        , EML_ID
        , ADDR
        , DTL_ADDR
        , LST_LGN_IP
        , LST_LGN_DT
        , DELT_FLG
        , EMPE_NO
        , RESDNT_RGST_NO
        , OFC_PSN_CD
        , JOIN_CO_DT
        , RESGN_CO_DT
        , EMPE_PLC_NM
        , LAST_ORD_NO
        , USR_IMG
        , CRE_USR_ID
        , CRE_DT
        , UPD_USR_ID
        , UPD_DT
        , SGN_NM
        , CHNL_CD
        , TM_PAY_FLG
        , TM_PAY_AMT
        , EMP_LOC_CD
      ) VALUES (
          #USR_ID#
        , #USR_PWD#
        , #USR_N1ST_NM#
        , #USR_LST_NM#
        , #GRP_ID#
        , #PHN_NO#
        , #CELL_PHN_NO#
        , #EML_ID#
        , #ADDR#
        , #DTL_ADDR#
        , #LST_LGN_IP#
        , #LST_LGN_DT#
        , #DELT_FLG#
        , #EMPE_NO#
        , #RESDNT_RGST_NO#
        , #OFC_PSN_CD#
        , #JOIN_CO_DT#
        , #RESGN_CO_DT#
        , #EMPE_PLC_NM#
        , #LAST_ORD_NO#
        , #USR_IMG#
        , #CRE_USR_ID#
        , GETDATE()
        , #UPD_USR_ID#
        , GETDATE()
        , #SGN_NM#
        , #CHNL_CD#
        , #TM_PAY_FLG#
        , #TM_PAY_AMT#
        , #EMP_LOC_CD#
      )
    </insert>
    
    <!-- 사용자 정보 수정 -->
    <update id="S136UpdateUserInfo" parameterClass="ModelsLibrary.Auth.GroupUserVo">
      UPDATE TB_SYS_USR
      SET 
          USR_N1ST_NM    = #USR_N1ST_NM#
        , USR_LST_NM     = #USR_LST_NM#
        , GRP_ID         = #GRP_ID#
        , PHN_NO         = #PHN_NO#
        , CELL_PHN_NO    = #CELL_PHN_NO#
        , EML_ID         = #EML_ID#
        , ADDR           = #ADDR#
        , DTL_ADDR       = #DTL_ADDR#
        , LST_LGN_IP     = #LST_LGN_IP#
        , LST_LGN_DT     = #LST_LGN_DT#
        , DELT_FLG       = #DELT_FLG#
        , EMPE_NO        = #EMPE_NO#
        , RESDNT_RGST_NO = #RESDNT_RGST_NO#
        , OFC_PSN_CD     = #OFC_PSN_CD#
        , JOIN_CO_DT     = #JOIN_CO_DT#
        , RESGN_CO_DT    = #RESGN_CO_DT#
        , EMPE_PLC_NM    = #EMPE_PLC_NM#
        , LAST_ORD_NO    = #LAST_ORD_NO#
        , USR_IMG        = #USR_IMG#
        , UPD_USR_ID     = #UPD_USR_ID#
        , UPD_DT         = GETDATE()
        , SGN_NM         = #SGN_NM#
        , TM_PAY_FLG     = #TM_PAY_FLG#
        , TM_PAY_AMT     = #TM_PAY_AMT#
        , EMP_LOC_CD     = #EMP_LOC_CD#
      <isNotNull property="USR_PWD" >
        , USR_PWD      = #USR_PWD#
      </isNotNull>
      WHERE 1 = 1
        AND USR_ID = #USR_ID#
        AND CHNL_CD = #CHNL_CD#
    </update>

    <!-- 사용자 삭제 -->
    <delete id="S136DeleteUserInfo" parameterClass="ModelsLibrary.Auth.GroupUserVo">
      DELETE   FROM TB_SYS_USR
      WHERE 1 = 1
        AND USR_ID = #USR_ID#
        AND CHNL_CD = #CHNL_CD#
    </delete>
    
    <!-- 그룹&사용자 조회  -->
    <!-- 반드시 작업장 필수 조건으로 조회가 되어야 합니다. (복수 사업자 대상) -->
    <select id="S136SelectGroupUserTreeList" resultClass="ModelsLibrary.Auth.GroupUserVo"  parameterClass="ModelsLibrary.Auth.GroupUserVo" >
      SELECT GRP_ID
      , GRP_NM
      , GRP_DESC
      , PRNT_GRP_ID
      , ISNULL((SELECT GRP_NM FROM TB_SYS_GRP AS A WHERE 1=1 AND A.CHNL_CD = #CHNL_CD# AND A.GRP_ID = T1.PRNT_GRP_ID), '')  AS PRNT_GRP_NM
      , USR_ID
      , ISNULL(USR_ID + ' ' + USR_N1ST_NM, GRP_ID + ' ' + GRP_NM) AS USR_N1ST_NM
      , ISNULL(USR_N1ST_NM, 'G') AS IS_GROUP
      , ISNULL(DELT_FLG ,'') AS DELT_FLG
      , CHNL_CD
	  , OSTR_FLG
      FROM
      (
      SELECT 'B' AS GBN
        , CAST(T2.USR_ID  AS VARCHAR) AS GRP_ID
        , T1.GRP_NM
        , T1.GRP_DESC
        , CAST(T1.GRP_ID  AS VARCHAR) AS PRNT_GRP_ID
        , T2.USR_ID
        , T2.USR_N1ST_NM
        , T2.DELT_FLG
        , T1.CHNL_CD 
		, T1.OSTR_FLG
      FROM TB_SYS_GRP T1
         , TB_SYS_USR T2
      WHERE 1 = 1
        AND T1.GRP_ID = T2.GRP_ID
        AND T1.CHNL_CD = T2.CHNL_CD
        AND T1.CHNL_CD = #CHNL_CD#
      <isNotNull property="DELT_FLG" >
        AND T2.DELT_FLG = #DELT_FLG#
      </isNotNull>
      <!--<isNotNull property="EMPE_PLC_NM" >
        AND T2.EMPE_PLC_NM = #EMPE_PLC_NM#
      </isNotNull>-->
      <isNotNull property="USR_ID" >
        AND T2.USR_ID LIKE #USR_ID# + '%'
      </isNotNull>
        AND T1.GRP_TP_CD = 'G'
   UNION ALL
        SELECT 'A' AS GBN
          , CAST(T1.GRP_ID AS VARCHAR) AS GRP_ID
          , T1.GRP_NM
          , T1.GRP_DESC
          , CAST(T1.PRNT_GRP_ID AS VARCHAR) AS PRNT_GRP_ID
          , NULL AS USR_ID
          , NULL AS USR_N1ST_NM
          , NULL AS DELT_FLG
          , T1.CHNL_CD
		  , T1.OSTR_FLG
        FROM TB_SYS_GRP T1
        WHERE 1 = 1
          AND T1.GRP_TP_CD = 'G'
          AND CHNL_CD = #CHNL_CD#
      ) T1
    </select>
    
    <!-- 그룹 메뉴 권한 조회   -->
    <select id="S136SelectProgramGroupList" resultClass="ModelsLibrary.Auth.ProgramVo" parameterClass="ModelsLibrary.Auth.ProgramVo">
		SELECT T1.MDL_ID
		, T1.PRNT_MDL_ID
		, CONCAT('[', T1.MDL_ID, '] ', T1.MDL_NM) MDL_NM
		, CASE WHEN ISNULL(T2.VIS_FLG, 'N') = 'Y' THEN 1 ELSE 0 END AS VIS_FLG
		, CASE WHEN ISNULL(T2.UPD_FLG, 'N') = 'Y' THEN 1 ELSE 0 END AS UPD_FLG
		, T1.PGM_CD
		, T1.CHNL_CD
		, T1.ICON_FILE AS IMAGE
		FROM TB_SYS_PGM     T1
		LEFT OUTER JOIN  TB_SYS_GRP_PGM T2 ON ( T1.MDL_ID = T2.MDL_ID AND T1.CHNL_CD = T2.CHNL_CD AND T2.GRP_ID = #GRP_ID# )
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.DELT_FLG = 'N'
		AND T1.CHNL_CD = #CHNL_CD#
		ORDER BY T1.MDL_ID
	</select>
    
    <!-- 사용자 메뉴 권한 조회   -->
    <select id="S136SelectProgramUserList" resultClass="ModelsLibrary.Auth.ProgramVo" parameterClass="ModelsLibrary.Auth.ProgramVo">
		SELECT T1.MDL_ID
		, T1.PRNT_MDL_ID
		, CONCAT('[', T1.MDL_ID, '] ', T1.MDL_NM) MDL_NM
		, CASE WHEN ISNULL(T2.VIS_FLG, 'N') = 'Y' THEN 1 ELSE 0 END AS VIS_FLG
		, CASE WHEN ISNULL(T2.UPD_FLG, 'N') = 'Y' THEN 1 ELSE 0 END AS UPD_FLG
		, T1.PGM_CD
		, T1.CHNL_CD
		, T1.ICON_FILE AS IMAGE
		FROM TB_SYS_PGM     T1
		LEFT OUTER JOIN  TB_SYS_GRP_PGM T2 ON ( T1.MDL_ID = T2.MDL_ID AND T1.CHNL_CD = T2.CHNL_CD AND T2.GRP_ID = #GRP_ID# )
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.DELT_FLG = 'N'
		AND T1.CHNL_CD = #CHNL_CD#
		AND NOT EXISTS (SELECT 'X' FROM TB_SYS_USR_PGM Z WHERE Z.MDL_ID = T1.MDL_ID AND T1.CHNL_CD = Z.CHNL_CD AND Z.USR_ID = #USR_ID# )
		UNION ALL
		SELECT T1.MDL_ID
		, T1.PRNT_MDL_ID
		, CONCAT('[', T1.MDL_ID, '] ', T1.MDL_NM) MDL_NM
		, CASE WHEN ISNULL(T2.VIS_FLG, 'N') = 'Y' THEN 1 ELSE 0 END AS VIS_FLG
		, CASE WHEN ISNULL(T2.UPD_FLG, 'N') = 'Y' THEN 1 ELSE 0 END AS UPD_FLG
		, T1.PGM_CD
		, T1.CHNL_CD
		, T1.ICON_FILE AS IMAGE
		FROM TB_SYS_PGM     T1
		, TB_SYS_USR_PGM T2
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.MDL_ID = T2.MDL_ID
		AND T1.CHNL_CD = T2.CHNL_CD
		AND T1.CHNL_CD = #CHNL_CD#
		AND T2.USR_ID =  #USR_ID#
		AND T1.DELT_FLG = 'N'
		ORDER BY T1.MDL_ID
	</select>

    <!-- 그룹 프로그램 등록-->
    <insert id="S136InsertGroupProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      INSERT INTO TB_SYS_GRP_PGM (
      MDL_ID, GRP_ID, VIS_FLG, UPD_FLG, CRE_USR_ID, CRE_DT, UPD_USR_ID, UPD_DT, CHNL_CD
      ) VALUES (
      #MDL_ID#, #GRP_ID#, #VIS_FLG#, #UPD_FLG#, #CRE_USR_ID#, GETDATE(), #UPD_USR_ID#, GETDATE(), #CHNL_CD#
      )
    </insert>
    <!-- 그룹 프로그램 수정-->
    <update id="S136UpdateGroupProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
       UPDATE TB_SYS_GRP_PGM
          SET VIS_FLG = #VIS_FLG#
            , UPD_FLG = #UPD_FLG#
        WHERE 1 = 1
          AND MDL_ID  = #MDL_ID#
          AND GRP_ID  = #GRP_ID#
          AND CHNL_CD = #CHNL_CD#
    </update>
    <!-- 그룹 프로그램 삭제-->    
    <delete id="S136DeleteGroupProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      DELETE TB_SYS_GRP_PGM
      WHERE 1 = 1
        AND CHNL_CD = #CHNL_CD#
      <isNotNull property="MDL_ID" >
        AND MDL_ID = #MDL_ID#
      </isNotNull>
      <isNotNull property="GRP_ID" >
        AND GRP_ID = #GRP_ID#
      </isNotNull>
    </delete>
    <!-- 사용자 프로그램 등록-->
    <insert id="S136InsertUserProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      INSERT INTO TB_SYS_USR_PGM (
        USR_ID, MDL_ID, VIS_FLG, UPD_FLG, CRE_USR_ID, CRE_DT, UPD_USR_ID, UPD_DT, CHNL_CD
      ) VALUES (
        #USR_ID#, #MDL_ID#, #VIS_FLG#, #UPD_FLG#, #CRE_USR_ID#, GETDATE(), #UPD_USR_ID#, GETDATE(), #CHNL_CD#
      )
    </insert>
    <!-- 사용자 프로그램 수정-->
    <update id="S136UpdateUserProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      UPDATE TB_SYS_USR_PGM
         SET VIS_FLG = #VIS_FLG#
           , UPD_FLG = #UPD_FLG#
       WHERE 1 = 1
         AND MDL_ID = #MDL_ID#
         AND USR_ID = #USR_ID#
         AND CHNL_CD = #CHNL_CD#
    </update>
    <!-- 사용자 프로그램 삭제-->
    <delete id="S136DeleteUserProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      DELETE TB_SYS_USR_PGM
      WHERE 1 = 1
        AND CHNL_CD = #CHNL_CD#
      <isNotNull property="MDL_ID" >
        AND MDL_ID = #MDL_ID#
      </isNotNull>
      <isNotNull property="USR_ID" >
        AND USR_ID = #USR_ID#
      </isNotNull>
    </delete>
    
    
    
    <!-- 프로그램 메뉴 관리-->
    <select id="S139SelectProgramMenuTotalList" resultClass="ModelsLibrary.Auth.ProgramVo" parameterClass="ModelsLibrary.Auth.ProgramVo" >
      SELECT  MDL_ID
      , MDL_NM
      , MDL_DESC
      , PRNT_MDL_ID
      , ISNULL((SELECT MDL_NM FROM TB_SYS_PGM AS A WHERE 1=1 AND A.MDL_ID = T1.PRNT_MDL_ID AND A.CHNL_CD = T1.CHNL_CD), '')  AS PRNT_MDL_NM
      , PGM_CD
      , PGM_NM
      , PGM_IMG_NM
      , SRT_ORD_SEQ
      , SYS_AREA_CD
      , dbo.CD_SYS_CLSS_FNC(#CHNL_CD#, 'S-009', SYS_AREA_CD) AS SYS_AREA_NM
      , (CASE WHEN DELT_FLG = 'N' THEN '사용' ELSE '미사용' END) AS DELT_FLG
      , ICON_FILE AS IMAGE
      , CHNL_CD
      FROM TB_SYS_PGM T1
      WHERE 1=1
	  AND PGM_APLY_CD = 'WEB'
      AND CHNL_CD = #CHNL_CD#
      <isNotNull property="MDL_ID" >
        AND MDL_ID = #MDL_ID#
      </isNotNull>
      <isNotNull property="PRNT_MDL_ID" >
        <isEqual property="PRNT_MDL_ID" compareValue="PRNT_MDL_ID" >
          AND PGM_CD NOT IN('A', 'P')
        </isEqual>
      </isNotNull>

      <!--<isNotNull property="PGM_CD_LIST" >
        AND PGM_CD 
        <iterate prepend="NOT IN" property="PGM_CD_LIST" open="(" close=")" conjunction=",">
          #PGM_CD_LIST[]#
        </iterate>
      </isNotNull>-->
    </select>

    <!-- 프로그램 등록-->
    <insert id="S139InsertProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      INSERT INTO TB_SYS_PGM (
      MDL_ID, MDL_NM , MDL_DESC , PRNT_MDL_ID , PGM_CD , PGM_NM , PGM_IMG_NM, SRT_ORD_SEQ, SYS_AREA_CD, DELT_FLG, CRE_USR_ID, CRE_DT, UPD_USR_ID, UPD_DT, CHNL_CD, ICON_FILE
      ) VALUES (
      #MDL_ID#, #MDL_NM#, #MDL_DESC#, #PRNT_MDL_ID#, #PGM_CD#, #PGM_NM#, #PGM_IMG_NM#, #SRT_ORD_SEQ#, #SYS_AREA_CD#, #DELT_FLG#, #CRE_USR_ID#, GETDATE(), #UPD_USR_ID#, GETDATE(), #CHNL_CD#, #IMAGE#
      )
    </insert>
    <!-- 프로그램 수정-->
    <update id="S139UpdateProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      UPDATE TB_SYS_PGM
      SET MDL_NM = #MDL_NM#
      , MDL_DESC = #MDL_DESC#
      , PRNT_MDL_ID = #PRNT_MDL_ID#
      , PGM_CD = #PGM_CD#
      , PGM_NM = #PGM_NM#
      , PGM_IMG_NM = #PGM_IMG_NM#
      , SRT_ORD_SEQ = #SRT_ORD_SEQ#
      , SYS_AREA_CD = #SYS_AREA_CD#
      , DELT_FLG = #DELT_FLG#
      , UPD_USR_ID = #UPD_USR_ID#
      , UPD_DT = GETDATE()
      , ICON_FILE = #IMAGE#
      WHERE 1 = 1
        AND MDL_ID = #MDL_ID#
        AND CHNL_CD = #CHNL_CD#
    </update>
    <!-- 프로그램 삭제-->
    <delete id="S139DeleteProgram" parameterClass="ModelsLibrary.Auth.ProgramVo">
      DELETE TB_SYS_PGM
      WHERE 1 = 1
        AND MDL_ID = #MDL_ID#
        AND CHNL_CD = #CHNL_CD#
    </delete>
    <!-- 프로그램 메뉴 관리-->
    
    
    
    
    
      
   <!-- 프로그램 채널-->
   <select id="SelectChnlList" resultClass="ModelsLibrary.Auth.ProgramVo" parameterClass="ModelsLibrary.Auth.ProgramVo" >
      SELECT 
          CHNL_CD
        , CHNL_NM  
        , ISNULL(CHNL_LOG_IMG, 0x) AS CHNL_LOG_IMG
        , ISNULL(CHNL_SIGN_IMG, 0x) AS CHNL_SIGN_IMG
       FROM TB_CHNL_CD 
        WHERE DELT_FLG  = #DELT_FLG#
        <isNotNull property="CHNL_CD" >
          AND CHNL_CD   = #CHNL_CD#
        </isNotNull>
    </select>
    
     <!-- 프로그램 채널 이미지 등록-->
    <update id="UpdateChnl" parameterClass="ModelsLibrary.Auth.ProgramVo">
        UPDATE TB_CHNL_CD 
          SET 
              UPD_USR_ID    = #UPD_USR_ID#
            , UPD_DT        = GETDATE()
             <isNotNull property="CHNL_LOG_IMG" >
            , CHNL_LOG_IMG  = #CHNL_LOG_IMG#
            </isNotNull>
            <isNotNull property="CHNL_SIGN_IMG" >
            , CHNL_SIGN_IMG = #CHNL_SIGN_IMG#
            </isNotNull>
          WHERE DELT_FLG    = #DELT_FLG#
            AND CHNL_CD     = #CHNL_CD#
    </update>
        
    <!-- 프로그램 메뉴-->
    <select id="SelectProgramMenuList" resultClass="ModelsLibrary.Auth.ProgramVo" parameterClass="ModelsLibrary.Auth.ProgramVo" >
		WITH MENU_LIST AS (
		SELECT  GBN
		, MDL_ID
		, CONCAT('[', MDL_ID, '] ', MDL_NM) MDL_NM
		, MDL_DESC
		, PRNT_MDL_ID
		, PGM_CD
		, PGM_NM
		, PGM_IMG_NM
		, SRT_ORD_SEQ
		, SYS_AREA_CD
		, VIS_FLG
		, UPD_FLG
		, ICON_FILE
		FROM (
		SELECT 'A' GBN
		, T1.MDL_ID
		, T1.PRNT_MDL_ID
		, T1.MDL_NM
		, ISNULL(T2.VIS_FLG, 'N')  AS VIS_FLG
		, ISNULL(T2.UPD_FLG, 'N')  AS UPD_FLG
		, T1.MDL_DESC
		, T1.PGM_CD
		, T1.PGM_NM
		, T1.PGM_IMG_NM
		, T1.SRT_ORD_SEQ
		, T1.SYS_AREA_CD
		, T1.ICON_FILE
		FROM TB_SYS_PGM     T1
		LEFT OUTER JOIN  TB_SYS_GRP_PGM T2
		ON (
		T1.CHNL_CD = T2.CHNL_CD
		AND T1.MDL_ID = T2.MDL_ID
		AND T2.GRP_ID = (SELECT GRP_ID
		FROM TB_SYS_USR
		WHERE USR_ID =  #USR_ID#
		AND CHNL_CD = #CHNL_CD#
		)
		)
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.PGM_CD NOT IN ('G', 'T', 'M')
		AND T1.CHNL_CD = #CHNL_CD#
		AND T1.DELT_FLG = 'N'
		AND NOT EXISTS (SELECT 'X'
		FROM TB_SYS_USR_PGM Z
		WHERE Z.MDL_ID = T1.MDL_ID
		AND Z.USR_ID = #USR_ID#
		AND Z.CHNL_CD = #CHNL_CD#
		)
		UNION ALL
		SELECT 'B'
		, T1.MDL_ID
		, T1.PRNT_MDL_ID
		, T1.MDL_NM
		, ISNULL(T2.VIS_FLG, 'N')  AS VIS_FLG
		, ISNULL(T2.UPD_FLG, 'N')  AS UPD_FLG
		, T1.MDL_DESC
		, T1.PGM_CD
		, T1.PGM_NM
		, T1.PGM_IMG_NM
		, T1.SRT_ORD_SEQ
		, T1.SYS_AREA_CD
		, T1.ICON_FILE
		FROM TB_SYS_PGM     T1
		, TB_SYS_USR_PGM T2
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.CHNL_CD = T2.CHNL_CD
		AND T1.DELT_FLG = 'N'
		AND T1.MDL_ID = T2.MDL_ID
		AND T2.USR_ID = #USR_ID#
		AND T1.CHNL_CD = #CHNL_CD#
		UNION ALL
		SELECT 'C'
		, T1.MDL_ID
		, T1.PRNT_MDL_ID
		, T1.MDL_NM
		, 'Y'  AS VIS_FLG
		, 'Y'  AS UPD_FLG
		, T1.MDL_DESC
		, T1.PGM_CD
		, T1.PGM_NM
		, T1.PGM_IMG_NM
		, T1.SRT_ORD_SEQ
		, T1.SYS_AREA_CD
		, T1.ICON_FILE
		FROM TB_SYS_PGM T1
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.CHNL_CD = #CHNL_CD#
		AND PGM_CD IN ('G', 'T', 'M')
		AND MDL_ID IN  (
		SELECT T1.PRNT_MDL_ID
		FROM TB_SYS_PGM T1
		, TB_SYS_GRP_PGM T2
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.CHNL_CD = T2.CHNL_CD
		AND T1.MDL_ID = T2.MDL_ID
		AND T2.VIS_FLG = 'Y'
		AND T2.CHNL_CD = #CHNL_CD#
		UNION ALL
		SELECT T1.PRNT_MDL_ID
		FROM TB_SYS_PGM T1
		, TB_SYS_USR_PGM T2
		WHERE 1 = 1
		AND T1.PGM_APLY_CD = 'WEB'
		AND T1.CHNL_CD = T2.CHNL_CD
		AND T1.MDL_ID = T2.MDL_ID
		AND T2.VIS_FLG = 'Y'
		AND T2.CHNL_CD = #CHNL_CD#
		)
		) T1
		WHERE VIS_FLG   = 'Y'
		)
		, A_TMP AS (
		SELECT  PRNT_MDL_ID
		FROM (
		SELECT PRNT_MDL_ID
		FROM MENU_LIST
		WHERE 1 = 1
		AND PGM_CD = 'A'
		UNION ALL
		SELECT PRNT_MDL_ID
		FROM MENU_LIST
		WHERE 1 = 1
		AND MDL_ID IN (
		SELECT PRNT_MDL_ID
		FROM MENU_LIST
		WHERE 1 = 1
		AND PGM_CD = 'A'
		)
		) T1
		WHERE 1 = 1
		GROUP BY PRNT_MDL_ID
		)
		SELECT MDL_ID
		, MDL_NM
		, MDL_DESC
		, PRNT_MDL_ID
		, PGM_CD
		, PGM_NM
		, PGM_IMG_NM
		, SRT_ORD_SEQ
		, SYS_AREA_CD
		, VIS_FLG
		, UPD_FLG
		, ICON_FILE AS IMAGE
		FROM MENU_LIST X
		WHERE 1 = 1
		AND MDL_ID  IN (SELECT PRNT_MDL_ID FROM A_TMP )
		AND PRNT_MDL_ID NOT IN (
		SELECT  PRNT_MDL_ID
		FROM (
		SELECT PRNT_MDL_ID
		FROM MENU_LIST Z
		WHERE PRNT_MDL_ID NOT IN ('T')
		GROUP BY PRNT_MDL_ID
		) T1
		WHERE NOT EXISTS ( SELECT 'X'
		FROM MENU_LIST Z
		WHERE T1.PRNT_MDL_ID = Z.MDL_ID
		)

		)
		GROUP BY MDL_ID
		, MDL_NM
		, MDL_DESC
		, PRNT_MDL_ID
		, PGM_CD
		, PGM_NM
		, PGM_IMG_NM
		, SRT_ORD_SEQ
		, SYS_AREA_CD
		, VIS_FLG
		, UPD_FLG
		, ICON_FILE
		UNION ALL
		SELECT MDL_ID
		, MDL_NM
		, MDL_DESC
		, PRNT_MDL_ID
		, PGM_CD
		, PGM_NM
		, PGM_IMG_NM
		, SRT_ORD_SEQ
		, SYS_AREA_CD
		, VIS_FLG
		, UPD_FLG
		, ICON_FILE AS IMAGE
		FROM MENU_LIST X
		WHERE 1 = 1
		AND PRNT_MDL_ID  IN (SELECT PRNT_MDL_ID FROM A_TMP )
		AND PGM_CD = 'A'
		AND PRNT_MDL_ID NOT IN (
		SELECT  PRNT_MDL_ID
		FROM (
		SELECT PRNT_MDL_ID
		FROM MENU_LIST Z
		WHERE PRNT_MDL_ID NOT IN ('T')
		GROUP BY PRNT_MDL_ID
		) T1
		WHERE NOT EXISTS ( SELECT 'X'
		FROM MENU_LIST Z
		WHERE T1.PRNT_MDL_ID = Z.MDL_ID
		)

		)
		GROUP BY MDL_ID
		, MDL_NM
		, MDL_DESC
		, PRNT_MDL_ID
		, PGM_CD
		, PGM_NM
		, PGM_IMG_NM
		, SRT_ORD_SEQ
		, SYS_AREA_CD
		, VIS_FLG
		, UPD_FLG
		, ICON_FILE
		ORDER BY PRNT_MDL_ID, SRT_ORD_SEQ


		<!--WITH MENU_LIST AS (
      SELECT  GBN , MDL_ID
      , MDL_NM
      , MDL_DESC
      , PRNT_MDL_ID
      , PGM_CD
      , PGM_NM
      , PGM_IMG_NM
      , SRT_ORD_SEQ
      , SYS_AREA_CD
      , VIS_FLG
      , UPD_FLG
      , ICON_FILE
      FROM (
      SELECT 'A' GBN
      , T1.MDL_ID
      , T1.PRNT_MDL_ID
      , T1.MDL_NM
      , ISNULL(T2.VIS_FLG, 'N')  AS VIS_FLG
      , ISNULL(T2.UPD_FLG, 'N')  AS UPD_FLG
      , T1.MDL_DESC
      , T1.PGM_CD
      , T1.PGM_NM
      , T1.PGM_IMG_NM
      , T1.SRT_ORD_SEQ
      , T1.SYS_AREA_CD
      , T1.ICON_FILE
      FROM TB_SYS_PGM     T1
      LEFT OUTER JOIN  TB_SYS_GRP_PGM T2 ON (
          T1.CHNL_CD = T2.CHNL_CD
      AND T1.MDL_ID = T2.MDL_ID
      AND T2.GRP_ID = (SELECT GRP_ID
      FROM TB_SYS_USR
      WHERE USR_ID =  #USR_ID#
      AND CHNL_CD = #CHNL_CD#
      )
      )
      WHERE 1 = 1
	  AND T1.PGM_APLY_CD = 'WEB'
      AND T1.PGM_CD NOT IN ('G', 'T', 'M')
      AND T1.CHNL_CD = #CHNL_CD#
      AND T1.DELT_FLG = 'N'
      AND NOT EXISTS (SELECT 'X'
      FROM TB_SYS_USR_PGM Z
      WHERE Z.MDL_ID = T1.MDL_ID
      AND Z.USR_ID = #USR_ID#
      AND Z.CHNL_CD = #CHNL_CD#
      )
      UNION ALL
      SELECT 'B'
      , T1.MDL_ID
      , T1.PRNT_MDL_ID
      , T1.MDL_NM
      , ISNULL(T2.VIS_FLG, 'N')  AS VIS_FLG
      , ISNULL(T2.UPD_FLG, 'N')  AS UPD_FLG
      , T1.MDL_DESC
      , T1.PGM_CD
      , T1.PGM_NM
      , T1.PGM_IMG_NM
      , T1.SRT_ORD_SEQ
      , T1.SYS_AREA_CD
      , T1.ICON_FILE
      FROM TB_SYS_PGM     T1
      , TB_SYS_USR_PGM T2
      WHERE 1 = 1
	  AND T1.PGM_APLY_CD = 'WEB'
      AND T1.CHNL_CD = T2.CHNL_CD
      AND T1.DELT_FLG = 'N'
      AND T1.MDL_ID = T2.MDL_ID
      AND T2.USR_ID = #USR_ID#
      AND T1.CHNL_CD = #CHNL_CD#
      UNION ALL
      SELECT 'C'
      , T1.MDL_ID
      , T1.PRNT_MDL_ID
      , T1.MDL_NM
      , 'Y'  AS VIS_FLG
      , 'Y'  AS UPD_FLG
      , T1.MDL_DESC
      , T1.PGM_CD
      , T1.PGM_NM
      , T1.PGM_IMG_NM
      , T1.SRT_ORD_SEQ
      , T1.SYS_AREA_CD
      , T1.ICON_FILE
      FROM TB_SYS_PGM T1
      WHERE 1 = 1
	  AND T1.PGM_APLY_CD = 'WEB'
      AND T1.CHNL_CD = #CHNL_CD#
      AND PGM_CD IN ('G', 'T', 'M')
      AND MDL_ID IN  (
      SELECT T1.PRNT_MDL_ID
      FROM TB_SYS_PGM T1
      , TB_SYS_GRP_PGM T2
      WHERE 1 = 1
	  AND T1.PGM_APLY_CD = 'WEB'
      AND T1.CHNL_CD = T2.CHNL_CD
      AND T1.MDL_ID = T2.MDL_ID
      AND T2.VIS_FLG = 'Y'
      AND T2.CHNL_CD = #CHNL_CD#
      UNION ALL
      SELECT T1.PRNT_MDL_ID
      FROM TB_SYS_PGM T1
      , TB_SYS_USR_PGM T2
      WHERE 1 = 1
	  AND T1.PGM_APLY_CD = 'WEB'
      AND T1.CHNL_CD = T2.CHNL_CD
      AND T1.MDL_ID = T2.MDL_ID
      AND T2.VIS_FLG = 'Y'
      AND T2.CHNL_CD = #CHNL_CD#
      )
      ) T1
      WHERE VIS_FLG   = 'Y'
      )
      SELECT MDL_ID
      , MDL_NM
      , MDL_DESC
      , PRNT_MDL_ID
      , PGM_CD
      , PGM_NM
      , PGM_IMG_NM
      , SRT_ORD_SEQ
      , SYS_AREA_CD
      , VIS_FLG
      , UPD_FLG
      , ICON_FILE AS IMAGE
      FROM MENU_LIST X
      WHERE 1 = 1
      AND PRNT_MDL_ID NOT IN (
      SELECT  PRNT_MDL_ID
      FROM (
      SELECT PRNT_MDL_ID
      FROM MENU_LIST Z
      WHERE PRNT_MDL_ID NOT IN ('T')
      GROUP BY PRNT_MDL_ID
      ) T1
      WHERE NOT EXISTS (SELECT 'X'
      FROM MENU_LIST Z
      WHERE T1.PRNT_MDL_ID = Z.MDL_ID
	     --><!--AND SYS_AREA_CD NOT IN ('008')--><!--
      )
      )
      GROUP BY MDL_ID
      , MDL_NM
      , MDL_DESC
      , PRNT_MDL_ID
      , PGM_CD
      , PGM_NM
      , PGM_IMG_NM
      , SRT_ORD_SEQ
      , SYS_AREA_CD
      , VIS_FLG
      , UPD_FLG
      , ICON_FILE
     ORDER BY PRNT_MDL_ID, SRT_ORD_SEQ-->
    </select>



  </statements>
</sqlMap>